#!/bin/bash

# 提交信息匹配三种情况
git_test_branch_name="test"
merge_patterns=(
  "Merge branch '$git_test_branch_name'"
  "Merge branch 'origin/$git_test_branch_name'"
  "Merge remote-tracking branch 'origin/$git_test_branch_name'"
)

# 构造正则表达式
regex_pattern=$(IFS=\|; echo "${merge_patterns[*]}")

# 遍历当前分支的所有合并提交并检查消息
if git rev-list HEAD --first-parent --merges | grep -qE "$regex_pattern"; then
  echo "存在测试分支合并到当前分支的操作，具体记录如下："
  git log HEAD --first-parent --merges --grep="$regex_pattern"
  echo "merge了测试分支 $git_test_branch_name 到当前分支,无法push!!!"
  echo "警告: 当前分支不允许接收来自测试分支的合并!!!"
  exit 1
fi

echo "检查通过，未发现违规的合并操作。"
exit 0